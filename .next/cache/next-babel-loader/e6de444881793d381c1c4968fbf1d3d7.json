{"ast":null,"code":"import _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\nvar __jsx = React.createElement;\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nimport React, { useEffect, useState, useRef } from \"react\";\nimport KeyboardBackspaceIcon from \"@material-ui/icons/KeyboardBackspace\";\nimport { makeStyles } from \"@material-ui/core/styles\";\nimport { commonStyles, desktopStyles, tabStyles, mobileStyles } from \"./styles\";\nimport CircularProgress from \"@material-ui/core/CircularProgress\";\nimport { createMessage, fetchMessages, readAll } from \"../../apis/chat-api\";\nimport dialogs from \"../../redux/reducers/dialogs\";\nimport Message from \"./Message\";\nimport { AddToPhotosSharp } from \"@material-ui/icons\";\nimport moment from \"moment\";\nimport { Button, Typography } from \"@material-ui/core\";\nimport ConnectyCube from \"connectycube\"; // import Loader from \"react-loader-spinner\";\n\nimport { useSelector, useDispatch } from \"react-redux\";\nimport { deleteAllMessages, pushMessage, setMessages } from \"../../redux/actions/messages\"; // import useSocket from \"../../Utils/useSocket\";\n\nimport Messages from \"./Messages\";\nimport { selectedDialog } from \"../../redux/actions/selectedDialog\";\nimport { getSeller, sendChatUpdate, updateOpenStatus } from \"../../apis/global-api\";\nvar useStyles = makeStyles(function (theme) {\n  var _objectSpread2;\n\n  return _objectSpread(_objectSpread({}, commonStyles), {}, (_objectSpread2 = {}, _defineProperty(_objectSpread2, theme.breakpoints.up(\"sm\"), desktopStyles), _defineProperty(_objectSpread2, theme.breakpoints.up(\"md\"), tabStyles), _defineProperty(_objectSpread2, theme.breakpoints.down(\"sm\"), mobileStyles), _objectSpread2));\n});\n\nvar ChatBox = function ChatBox(_ref) {\n  var selectedDialogVal = _ref.selectedDialogVal,\n      auth = _ref.auth,\n      goBack = _ref.goBack,\n      dialogsArr = _ref.dialogsArr,\n      updateDialogSeenBySeller = _ref.updateDialogSeenBySeller,\n      deleteDialogSeenBySeller = _ref.deleteDialogSeenBySeller;\n  var classes = useStyles();\n\n  var _useState = useState(true),\n      loading = _useState[0],\n      setloading = _useState[1];\n\n  var _useState2 = useState({}),\n      prevdialog = _useState2[0],\n      setprevdialog = _useState2[1];\n\n  var _useState3 = useState({}),\n      data = _useState3[0],\n      setdata = _useState3[1];\n\n  var _useState4 = useState(false),\n      showConfirmBox = _useState4[0],\n      setshowConfirmBox = _useState4[1];\n\n  var _useState5 = useState(false),\n      showConfirmLoader = _useState5[0],\n      setshowConfirmLoader = _useState5[1];\n\n  var _useState6 = useState(0),\n      page = _useState6[0],\n      setpage = _useState6[1];\n\n  var _useState7 = useState(\"\"),\n      userMsg = _useState7[0],\n      setuserMsg = _useState7[1];\n\n  var msgs = useSelector(function (state) {\n    return state.messages;\n  }); // const socket = useSocket()\n  // const [msgs, setmsgs] = useState([]);\n\n  var _useState8 = useState(\"\"),\n      user = _useState8[0],\n      setuser = _useState8[1];\n\n  var _useState9 = useState(\"\"),\n      title = _useState9[0],\n      settitle = _useState9[1];\n\n  var _useState10 = useState(\"\"),\n      link = _useState10[0],\n      setlink = _useState10[1];\n\n  var _useState11 = useState(\"\"),\n      chatType = _useState11[0],\n      setchatType = _useState11[1];\n\n  var _useState12 = useState(false),\n      connected = _useState12[0],\n      setconnected = _useState12[1];\n\n  var dispatch = useDispatch();\n  var chatBoxREf = useRef(\"\");\n  useEffect(function () {\n    if (!selectedDialogVal.id) {\n      setloading(false);\n      setuser(\"\");\n      settitle(\"\");\n      setlink(\"\");\n      setpage(0);\n      return;\n    } // if (prevdialog.id != selectedDialogVal.id) {\n    // setloading(false);\n    // setloading(true);\n\n\n    setprevdialog(selectedDialogVal);\n    getMessages(1); // }\n\n    var dialog = selectedDialogVal;\n\n    if (dialog && dialog.users.length) {\n      var _user = dialog.users.filter(function (item) {\n        return item.user.id != auth.id;\n      });\n\n      _user[0].user && getSeller(_user[0].user.id).then(function (data) {\n        return data && data.id && setuser(data);\n      }); // setuser(user[0].user);\n    }\n\n    if (dialog && dialog.related_data) {\n      var type = dialog.related;\n      var related_data = dialog.related_data;\n\n      var _link = \"/products/item/\".concat(related_data.id);\n\n      if (type == \"request\") {\n        _link = \"/buy-request\";\n      }\n\n      settitle(related_data.title);\n      setlink(_link);\n\n      if (dialog.opened_by_seller == 0 && dialog.related_data.seller_id == auth.id) {\n        setshowConfirmBox(true);\n      }\n    } // if (socket && auth && !connected) {\n    //     socket.on(`message.chat${auth.id}`, message => {\n    //         handleNewMsg(message)\n    //     });\n    //     setconnected(true)\n    // }\n\n  }, [selectedDialogVal]);\n\n  var handleNewMsg = function handleNewMsg(message) {\n    // if (message.data && message.data.dialog_id == selectedDialogVal.id) {\n    dispatch(pushMessage(message.data)); //     console.log('message2', message.data.dialog_id == selectedDialogVal.id)\n    //     // setmsgs(msgs.concat([message.data]))\n    // }\n    // console.log('message', message, selectedDialogVal)\n  };\n\n  var getMessages = function getMessages(pageNo) {\n    setuserMsg(\"\");\n    var count = pageNo ? pageNo : page + 1; // return\n\n    var dialogId = selectedDialogVal.connecty_dialog_id;\n    var skip = (count - 1) * 10;\n    var params = {\n      chat_dialog_id: dialogId,\n      sort_desc: \"date_sent\",\n      limit: 10,\n      skip: skip\n    };\n    console.log(\"selectedDialogVal\", selectedDialogVal);\n    ConnectyCube.chat.message.list(params).then(function (messages) {\n      if (messages.items.length) {\n        var newMsgs = messages.items.reverse().concat(msgs.messages);\n        setTimeout(function () {\n          scrollToBottom(!msgs.messages.length ? \"\" : 30);\n        }, 200);\n        dispatch(setMessages(newMsgs, selectedDialogVal));\n        setpage(count);\n      } else if (!msgs.messages.length) {\n        dispatch(setMessages([], selectedDialogVal));\n\n        if (count == 1) {\n          setuserMsg(selectedDialogVal.related == 'product' ? 'Do you still have this product?' : 'Do you still have this request');\n        }\n\n        setpage(-1);\n      }\n\n      ConnectyCube.chat.getLastUserActivity(userId).then(function (result) {\n        console.log(\"lastactive\", result);\n        var userId = result.userId;\n        var seconds = result.seconds; // 'userId' was 'seconds' ago\n      })[\"catch\"](function (error) {});\n    })[\"catch\"](function (error) {});\n  }; // const getMessages = (data, msgs = []) => {\n  //     // return\n  //     if (!msgs.length) {\n  //         dispatch(deleteAllMessages())\n  //     }\n  //     let count = 1;\n  //     if (data && data.current_page) {\n  //         count = data.current_page + 1;\n  //     }\n  //     let q = `?page=${count}`;\n  //     let dialog = selectedDialogVal;\n  //     if (!dialog) {\n  //         setloading(false);\n  //         return;\n  //     }\n  //     fetchMessages(dialog.id, q).then((data) => {\n  //         if (data && data.data) {\n  //             let newMsgs = data.data.reverse()\n  //             let msgData = newMsgs.concat(msgs);\n  //             dispatch(setMessages(msgData, selectedDialogVal))\n  //             console.log('testcount', count, msgData.length, selectedDialogVal.related)\n  //             if (count == 1 && !msgData.length) {\n  //                 setuserMsg(selectedDialogVal.related == 'product' ? 'Do you still have this product?' : '')\n  //             }\n  //             // setmsgs(msgData);\n  //             setdata(data);\n  //         }\n  //         if (!msgs.length) {\n  //             setTimeout(() => {\n  //                 scrollToBottom()\n  //             }, 200);\n  //         } else {\n  //             scrollToBottom(30)\n  //         }\n  //         // readAll(dialog.id, auth.id).then(data => console.log(data))\n  //     });\n  // };\n\n\n  var scrollToBottom = function scrollToBottom() {\n    var height = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : \"\";\n    setloading(false);\n\n    if (!chatBoxREf || !chatBoxREf.current) {\n      return;\n    }\n\n    chatBoxREf.current.scrollTop = height ? height : chatBoxREf.current.scrollHeight; // chatBoxREf.current.scrollTop = chatBoxREf.current.scrollHeight\n  };\n\n  var handleChatBoxScroll = function handleChatBoxScroll(e) {\n    var target = e.target;\n\n    if (!msgs.messages.length || page < 0) {\n      return;\n    }\n\n    if (!target.scrollTop) {\n      // setdialogLoader(true)\n      // getDialogs();\n      getMessages();\n    }\n  };\n\n  var sendMsg = function sendMsg(e) {\n    e.preventDefault();\n\n    if (!userMsg) {\n      return;\n    }\n\n    var dialog = selectedDialogVal;\n    var date = Math.floor(Date.now() / 1000);\n    var message = {\n      type: \"groupchat\",\n      body: userMsg,\n      message: userMsg,\n      dialog_id: dialog.connecty_dialog_id,\n      extension: {\n        save_to_history: 1,\n        dialog_id: dialog.connecty_dialog_id,\n        // sender_id: '2066645',\n        sender_id: auth.connectycube_user.connectycube_id,\n        date_sent: date\n      },\n      markable: 1,\n      sender_id: auth.connectycube_user.connectycube_id\n    };\n    dispatch(pushMessage(message)); // setmsgs(msgs.concat([data]))\n\n    setuserMsg(\"\");\n    message.id = ConnectyCube.chat.helpers.getBsonObjectId();\n    message = ConnectyCube.chat.send(dialog.xmpp_room_jid, message);\n    ConnectyCube.chat.getLastUserActivity(user.connectycube_user.connectycube_id).then(function (result) {\n      console.log(\"resultconect\", result);\n      var userId = result.userId;\n      var seconds = result.seconds;\n\n      if (seconds > 500) {\n        sendChatUpdate(user.id);\n        var message = {\n          app_id: process.env.ONESIGNAL_APP_ID,\n          contents: {\n            en: \"You recieved a new message.\"\n          },\n          filters: [{\n            field: \"tag\",\n            key: \"user\",\n            relation: \"=\",\n            value: user.id\n          }],\n          url: process.env.APP_URL + \"/chat\"\n        };\n        fetch(\"https://onesignal.com/api/v1/notifications\", {\n          headers: {\n            \"Content-Type\": \"application/json; charset=utf-8\",\n            Authorization: \"Basic \" + process.env.ONESIGNAL_REST_KEY\n          },\n          method: \"post\",\n          body: JSON.stringify(message) // body: JSON.stringify(data),\n\n        }).then(function (response) {\n          if (response.ok) {\n            return response.json();\n          } else {\n            throw Error(\"Request rejected with status \".concat(response.status));\n          }\n        }).then(function (responseData) {\n          console.log(\"responseDatasadsad\", responseData);\n          return responseData;\n        })[\"catch\"](function (error) {\n          return console.log(\"responseDatasadsad\", error);\n        });\n      } // 'userId' was 'seconds' ago\n\n    })[\"catch\"](function (error) {});\n    setTimeout(function () {\n      scrollToBottom();\n    }, 200);\n  };\n\n  var handleResponse = function handleResponse(status) {\n    setshowConfirmLoader(true);\n    updateOpenStatus(selectedDialogVal.id, status, auth.id).then(function (resp) {\n      console.log(resp);\n      setshowConfirmLoader(false);\n\n      if (status == \"yes\") {\n        setshowConfirmBox(false);\n        updateDialogSeenBySeller(selectedDialogVal, dialogsArr);\n      } else {\n        deleteDialogSeenBySeller(selectedDialogVal, dialogsArr);\n      }\n    });\n  }; // const sendMsg = (e) => {\n  //     e.preventDefault()\n  //     if (!userMsg) {\n  //         return\n  //     }\n  //     let data = {\n  //         dialog_id: selectedDialogVal.id,\n  //         user_id: auth.id,\n  //         message: userMsg,\n  //         created_at: new Date().toISOString()\n  //     }\n  //     dispatch(pushMessage(data))\n  //     // setmsgs(msgs.concat([data]))\n  //     setuserMsg('')\n  //     createMessage(data)\n  //         .then(resp => {\n  //             // console.log(resp)\n  //         })\n  //         .catch((err) => console.log(err))\n  //     socket.emit(\"sendmessage\", {\n  //         user: `message.chat${user.id}`,\n  //         type: 'message',\n  //         data: data\n  //     });\n  //     // console.log(userMsg)\n  // }\n\n\n  if (!selectedDialogVal.id) {\n    return __jsx(\"div\", {\n      className: \"right\"\n    }, __jsx(\"div\", {\n      className: \"top\"\n    }), __jsx(\"div\", {\n      className: \"chat\"\n    }, !loading && !dialogsArr.length && __jsx(\"div\", {\n      className: \"emptyDialog\"\n    }, __jsx(\"img\", {\n      src: \"/static/images/undraw_typing.svg\"\n    }), __jsx(Typography, null, \"Your message box is empty\")), !loading && dialogsArr.length > 0 && __jsx(\"div\", {\n      className: \"emptyDialog\"\n    }, __jsx(Typography, null, \"Please select a dialog to start chat\"))));\n  }\n\n  return __jsx(\"div\", {\n    className: \"right\"\n  }, __jsx(\"div\", {\n    className: \"top\"\n  }, __jsx(\"div\", {\n    className: classes.flex\n  }, __jsx(KeyboardBackspaceIcon, {\n    className: classes.backBtn,\n    onClick: goBack\n  }), __jsx(\"span\", null, \"To:\", \" \", __jsx(\"span\", {\n    className: \"name\"\n  }, user.first_name, \" \", user.last_name))), link ? __jsx(\"p\", null, __jsx(\"a\", {\n    href: link\n  }, title)) : __jsx(\"p\", null, title)), __jsx(\"div\", {\n    className: \"chat\",\n    onScroll: handleChatBoxScroll,\n    ref: chatBoxREf\n  }, loading && __jsx(\"div\", {\n    className: \"emptyDialog\"\n  }, __jsx(CircularProgress, {\n    color: \"primary\",\n    size: 30\n  })), __jsx(Messages, {\n    auth: auth\n  })), __jsx(\"div\", {\n    className: \"write\"\n  }, !loading && __jsx(React.Fragment, null, __jsx(\"a\", {\n    href: \"javascript:;\",\n    className: \"test\"\n  }), __jsx(\"input\", {\n    type: \"text\",\n    name: \"chatmessage\",\n    id: \"chatmessage\",\n    value: userMsg // className={classes.vHide}\n    ,\n    onChange: function onChange(e) {\n      return setuserMsg(e.target.value);\n    }\n  }), __jsx(\"a\", {\n    href: \"javascript:;\",\n    className: \"write-link send\",\n    onClick: sendMsg\n  }))), showConfirmBox && __jsx(\"div\", {\n    className: \"confirm-availability\"\n  }, __jsx(Typography, {\n    variant: \"h6\"\n  }, \"Please Confirm if this product is a valid product\"), link ? __jsx(\"p\", null, __jsx(\"a\", {\n    href: link\n  }, title)) : __jsx(\"p\", null, title), !showConfirmLoader && __jsx(\"div\", {\n    className: \"buttons\"\n  }, __jsx(Button, {\n    size: \"large\",\n    color: \"primary\",\n    variant: \"contained\",\n    style: {\n      marginRight: 5\n    },\n    onClick: function onClick() {\n      return handleResponse(\"yes\");\n    }\n  }, \"Yes\"), __jsx(Button, {\n    size: \"large\",\n    color: \"secondary\",\n    variant: \"contained\",\n    onClick: function onClick() {\n      return handleResponse(\"no\");\n    }\n  }, \"No\")), showConfirmLoader && __jsx(CircularProgress, {\n    color: \"primary\",\n    size: 30\n  }), __jsx(\"p\", {\n    className: \"info\"\n  }, \"By clicking on 'Yes', you can continue to chat\"), __jsx(\"p\", {\n    className: \"info\"\n  }, \"By clicking on 'No', the product will be automatically deleted.\")));\n};\n\nexport default ChatBox;","map":null,"metadata":{},"sourceType":"module"}