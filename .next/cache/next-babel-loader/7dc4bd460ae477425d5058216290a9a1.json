{"ast":null,"code":"var __jsx = React.createElement;\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nimport React, { useState, useEffect } from \"react\";\nimport { makeStyles } from \"@material-ui/core/styles\";\nimport { Card, CardContent, Typography, Dialog } from \"@material-ui/core\";\nimport { commonStyles, desktopStyles, mobileStyles } from \"./styles\";\nimport Link from \"next/link\";\nimport ConnectyCube from \"connectycube\";\nimport { useSelector, useDispatch } from \"react-redux\";\nimport store from \"../../redux/store\";\nimport PageLoader from \"../PageLoader\";\nimport { fetchDialogs } from \"../../apis/chat-api\";\nimport DialogBox from \"./DialogBox\";\nimport CircularProgress from \"@material-ui/core/CircularProgress\"; // import dialogs from \"../../redux/reducers/dialogs\";\n\nimport { selectedDialog } from \"../../redux/actions/selectedDialog\";\nimport ChatBox from \"./ChatBox\";\nimport { pushMessage } from \"../../redux/actions/messages\";\nconst useStyles = makeStyles(theme => _objectSpread(_objectSpread({}, commonStyles), {}, {\n  [theme.breakpoints.up(\"sm\")]: desktopStyles,\n  [theme.breakpoints.down(\"sm\")]: mobileStyles\n}));\n\nconst Chat = ({\n  type = \"\",\n  id = \"\"\n}) => {\n  const selectedDialogVal = useSelector(state => state.selectedDialog);\n  const chatConnected = useSelector(state => state.chatConnected); // const user = useSelector((state) => state.auth_user.user);\n\n  const {\n    0: dialogsArr,\n    1: setDialogs\n  } = useState([]);\n  const {\n    0: data,\n    1: setdata\n  } = useState([]);\n  const [open, setOpen] = React.useState(true);\n  const [loader, setloader] = React.useState(true);\n  const [dialogLoader, setdialogLoader] = React.useState(false);\n  const user = useSelector(state => state.auth_user.user);\n  const dispatch = useDispatch();\n  useEffect(() => {\n    if (!dialogsArr.length && chatConnected) {\n      // setUpListeners()\n      setloader(true);\n      getDialogs(type, id);\n    }\n  }, [type, id, user, chatConnected]); // const setUpListeners = () => {\n  //   ConnectyCube.chat.onMessageListener = onMessage;\n  // }\n\n  function onMessage(userId, message) {\n    if (!user || !user.connectycube_user || userId == user.connectycube_user.connectycube_id) {\n      return;\n    }\n\n    console.log(message);\n    message.message = message.body;\n    message.device_token = user.device_token;\n    message.notif = true;\n    dispatch(pushMessage(message));\n  }\n\n  const getDialogs = (type, id) => {\n    let count = 1;\n\n    if (data && data.current_page >= data.last_page) {\n      return;\n    }\n\n    if (data && data.current_page) {\n      count = data.current_page + 1;\n    }\n\n    let q = `?page=${count}`;\n\n    if (type, id) {\n      q += `&type=${type}&id=${id}`;\n    }\n\n    fetchDialogs(user.id, q).then(resp => {\n      let data = resp.body;\n\n      if (resp.error) {\n        alert(\"Oops!! there was some problem while connecting\");\n        return;\n      }\n\n      let dialogs = dialogsArr.concat(data.data);\n      setDialogs(dialogs);\n      setdata(data);\n      setloader(false);\n      setdialogLoader(false); // if (!chatAuthenticated && dialogs.length) {\n      //   selectDialog(dialogs[0], dialogs);\n      // }\n    });\n  };\n\n  const gotoChat = () => {\n    setOpen(false);\n  };\n\n  const goBack = () => {\n    setOpen(true);\n    dispatch(selectedDialog({}));\n    dispatch(pushMessage([]));\n  };\n\n  const handleDialogsSCroll = e => {\n    if (!dialogsArr.length || data.current_page == data.last_page) {\n      return;\n    }\n\n    let target = e.target;\n\n    if (target.scrollHeight - target.scrollTop === target.clientHeight) {\n      setdialogLoader(true);\n      getDialogs();\n    }\n  };\n\n  const selectDialog = (dialog, dialogs) => {\n    setOpen(false);\n    clearUnread(dialog.id, dialogs);\n    dispatch(selectedDialog(dialog));\n  };\n\n  const updateDialogSeenBySeller = (dialog, dialogs) => {\n    dialogs = dialogsArr.map(item => {\n      if (item.id == dialog.id) {\n        item.opened_by_seller = true;\n      }\n\n      return item;\n    });\n    console.log(\"dialogsupdate\", dialogs);\n    setDialogs(dialogs);\n  };\n\n  const deleteDialogSeenBySeller = (dialog, dialogs) => {\n    dialogs = dialogsArr.filter(item => item.id != dialog.id);\n    setDialogs(dialogs);\n    dispatch(selectedDialog({}));\n  };\n\n  const clearUnread = (id, dialogsArr = []) => {\n    let dialogs = dialogsArr.map(item => {\n      if (item.id == id) {\n        item.unread_messages_count = 0;\n      }\n\n      return item;\n    });\n    setDialogs(dialogs);\n  };\n\n  const classes = useStyles(); // if (!loader && !dialogsArr.length) {\n  //   return (\n  //     <div className={classes.wrapper}>\n  //       <div className=\"container\">\n  //         <div className=\"emptyDialog\">\n  //           <img src=\"/static/images/undraw_typing.svg\" />\n  //           <Typography >\n  //             Your message box is empty\n  //           </Typography>\n  //         </div>\n  //       </div>\n  //     </div>\n  //   )\n  // }\n\n  return __jsx(\"div\", {\n    className: classes.wrapper\n  }, __jsx(PageLoader, {\n    loading: loader\n  }), __jsx(\"div\", {\n    className: \"container\"\n  }, __jsx(\"div\", {\n    className: open == true ? \"left\" : \"active left\"\n  }, __jsx(\"div\", {\n    className: \"top\"\n  }, __jsx(Typography, {\n    variant: \"h4\"\n  }, \"Messages \")), __jsx(\"ul\", {\n    className: \"people\",\n    onScroll: handleDialogsSCroll\n  }, dialogsArr.length > 0 && dialogsArr.map(dialog => __jsx(DialogBox, {\n    dialog: dialog,\n    key: dialog.id,\n    auth: user,\n    selectDialog: selectDialog,\n    dialogs: dialogsArr,\n    unread_messages_count: dialog.unread_messages_count ? dialog.unread_messages_count : \"\"\n  })), dialogLoader && __jsx(\"div\", {\n    className: \"dialog-loader\"\n  }, __jsx(CircularProgress, {\n    color: \"primary\",\n    size: 20\n  })))), user && __jsx(ChatBox, {\n    dialogs: dialogsArr,\n    selectedDialogVal: selectedDialogVal ? selectedDialogVal : {},\n    auth: user,\n    goBack: goBack,\n    dialogsArr: dialogsArr,\n    updateDialogSeenBySeller: updateDialogSeenBySeller,\n    deleteDialogSeenBySeller: deleteDialogSeenBySeller\n  })));\n};\n\nexport default Chat;","map":null,"metadata":{},"sourceType":"module"}